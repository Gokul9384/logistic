{"version":3,"sources":["../../src/Helper/Exception.helper.ts"],"sourcesContent":["import { ArgumentsHost, Catch, ExceptionFilter } from '@nestjs/common';\r\nimport { Response } from 'express';\r\nimport { error_log } from '@Database/Table/Admin/error_log';\r\nimport { ResponseEnum } from './Enum/ResponseEnum';\r\nimport { EmptyUuid } from './Common.helper';\r\n\r\n@Catch()\r\nexport class ExceptionHelper implements ExceptionFilter {\r\n  async catch(exception: any, host: ArgumentsHost) {\r\n    const ctx = host.switchToHttp();\r\n    const response = ctx.getResponse<Response>();\r\n    let MessageText: string = \"\";\r\n    if (exception.code == \"ER_DUP_ENTRY\") {\r\n      MessageText = \"Duplicate record\";\r\n    }\r\n    else if (exception.message?.includes(\"ER_DUP_ENTRY\")) {\r\n      MessageText = \"Duplicate record\";\r\n    }\r\n    else if (exception.code == \"ER_ROW_IS_REFERENCED\") {\r\n      MessageText = \"Cannot delete or update used record\";\r\n    }\r\n    else if (exception.message?.includes(\"ER_ROW_IS_REFERENCED\")) {\r\n      MessageText = \"Cannot delete or update used record\";\r\n    }\r\n    else if (exception.code == \"ER_NO_REFERENCED_ROW_2\") {\r\n      var matches = exception.message.match(\"FOREIGN KEY (.*?) REFERENCES\");\r\n      MessageText = `${matches[1].replace(\"(`\", '').replace(\"`)\", '')} is invalid`;\r\n    }\r\n    else if (exception.message?.includes(\"ER_NO_REFERENCED_ROW_2\")) {\r\n      var matches = exception.message.match(\"FOREIGN KEY (.*?) REFERENCES\");\r\n      MessageText = `${matches[1].replace(\"(`\", '').replace(\"`)\", '')} is invalid`;\r\n    }\r\n\r\n    else {\r\n      if (Array.isArray(exception.response?.message)) {\r\n        MessageText = exception.response.message.join('\\n');\r\n      }\r\n      else if (exception.response?.message) {\r\n        MessageText = exception.response.message;\r\n      }\r\n      else if (exception.message) {\r\n        MessageText = exception.message;\r\n      }\r\n      else {\r\n        MessageText = exception.response;\r\n      }\r\n    }\r\n    await error_log.insert({\r\n      url: response.req.url,\r\n      ipaddress: response.req.ip ?? \"null\",\r\n      message: MessageText,\r\n      created_by_id: response.req?.user?.[\"user_id\"] ?? EmptyUuid,\r\n      created_by_name: response.req?.user?.[\"email\"] ?? \"No User\",\r\n      created_on: new Date()\r\n    })\r\n    response.json({ Type: ResponseEnum.Error, Message: MessageText }).status(500);\r\n  }\r\n}\r\n"],"names":["ExceptionHelper","catch","exception","host","ctx","switchToHttp","response","getResponse","MessageText","code","message","includes","matches","match","replace","Array","isArray","join","error_log","insert","url","req","ipaddress","ip","created_by_id","user","EmptyUuid","created_by_name","created_on","Date","json","Type","ResponseEnum","Error","Message","status"],"mappings":";;;;+BAOaA;;;eAAAA;;;wBAPyC;2BAE5B;8BACG;8BACH;;;;;;;AAGnB,IAAA,AAAMA,kBAAN,MAAMA;IACX,MAAMC,MAAMC,SAAc,EAAEC,IAAmB,EAAE;QAC/C,MAAMC,MAAMD,KAAKE,YAAY;QAC7B,MAAMC,WAAWF,IAAIG,WAAW;QAChC,IAAIC,cAAsB;QAC1B,IAAIN,UAAUO,IAAI,IAAI,gBAAgB;YACpCD,cAAc;QAChB,OACK,IAAIN,UAAUQ,OAAO,EAAEC,SAAS,iBAAiB;YACpDH,cAAc;QAChB,OACK,IAAIN,UAAUO,IAAI,IAAI,wBAAwB;YACjDD,cAAc;QAChB,OACK,IAAIN,UAAUQ,OAAO,EAAEC,SAAS,yBAAyB;YAC5DH,cAAc;QAChB,OACK,IAAIN,UAAUO,IAAI,IAAI,0BAA0B;YACnD,IAAIG,UAAUV,UAAUQ,OAAO,CAACG,KAAK,CAAC;YACtCL,cAAc,GAAGI,OAAO,CAAC,EAAE,CAACE,OAAO,CAAC,MAAM,IAAIA,OAAO,CAAC,MAAM,IAAI,WAAW,CAAC;QAC9E,OACK,IAAIZ,UAAUQ,OAAO,EAAEC,SAAS,2BAA2B;YAC9D,IAAIC,UAAUV,UAAUQ,OAAO,CAACG,KAAK,CAAC;YACtCL,cAAc,GAAGI,OAAO,CAAC,EAAE,CAACE,OAAO,CAAC,MAAM,IAAIA,OAAO,CAAC,MAAM,IAAI,WAAW,CAAC;QAC9E,OAEK;YACH,IAAIC,MAAMC,OAAO,CAACd,UAAUI,QAAQ,EAAEI,UAAU;gBAC9CF,cAAcN,UAAUI,QAAQ,CAACI,OAAO,CAACO,IAAI,CAAC;YAChD,OACK,IAAIf,UAAUI,QAAQ,EAAEI,SAAS;gBACpCF,cAAcN,UAAUI,QAAQ,CAACI,OAAO;YAC1C,OACK,IAAIR,UAAUQ,OAAO,EAAE;gBAC1BF,cAAcN,UAAUQ,OAAO;YACjC,OACK;gBACHF,cAAcN,UAAUI,QAAQ;YAClC;QACF;QACA,MAAMY,oBAAS,CAACC,MAAM,CAAC;YACrBC,KAAKd,SAASe,GAAG,CAACD,GAAG;YACrBE,WAAWhB,SAASe,GAAG,CAACE,EAAE,IAAI;YAC9Bb,SAASF;YACTgB,eAAelB,SAASe,GAAG,EAAEI,MAAM,CAAC,UAAU,IAAIC,uBAAS;YAC3DC,iBAAiBrB,SAASe,GAAG,EAAEI,MAAM,CAAC,QAAQ,IAAI;YAClDG,YAAY,IAAIC;QAClB;QACAvB,SAASwB,IAAI,CAAC;YAAEC,MAAMC,0BAAY,CAACC,KAAK;YAAEC,SAAS1B;QAAY,GAAG2B,MAAM,CAAC;IAC3E;AACF"}